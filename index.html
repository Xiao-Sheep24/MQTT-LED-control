<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 å¤šè‰² LED èˆ‡æº«æ¿•åº¦æ§åˆ¶</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .section-title {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    button {
      margin: 5px;
      padding: 20px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
    }
    #status {
      font-size: 20px;
      margin: 10px 0;
      color: green;
    }
    #sensor {
      font-size: 18px;
      margin: 10px 0;
    }
    #log {
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 250px;
      overflow-y: auto;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>

  <h1>ESP32 å¤šè‰² LED æ§åˆ¶ + æº«æ¿•åº¦é¡¯ç¤º</h1>

  <!-- ç‡ˆç‹€æ…‹ -->
  <div id="status">ğŸ”” ç‡ˆç‹€æ…‹ï¼šç›®å‰å…¨éƒ¨ç‚º OFF</div>

  <!-- æº«æ¿•åº¦ç‹€æ…‹ -->
  <div id="sensor">ğŸŒ¡ï¸ æº«åº¦ / æ¿•åº¦ å°šæœªæ¥æ”¶</div>

  <!-- ç‡ˆæ§åˆ¶æŒ‰éˆ• -->
  <div class="section-title">ğŸ’¡ ç‡ˆå…‰æ§åˆ¶</div>
  <div>
    <span>å®¢å»³</span><br>
    <button onclick="controlLED('red', 'on')">ç´…ç‡ˆ ON</button>
    <button onclick="controlLED('red', 'off')">ç´…ç‡ˆ OFF</button><br>

    <span>å»šæˆ¿</span><br>
    <button onclick="controlLED('green', 'on')">ç¶ ç‡ˆ ON</button>
    <button onclick="controlLED('green', 'off')">ç¶ ç‡ˆ OFF</button><br>

    <span>è‡¥å®¤</span><br>
    <button onclick="controlLED('yellow', 'on')">é»ƒç‡ˆ ON</button>
    <button onclick="controlLED('yellow', 'off')">é»ƒç‡ˆ OFF</button><br>

    <span>æµ´å®¤</span><br>
    <button onclick="controlLED('orange', 'on')">æ©˜ç‡ˆ ON</button>
    <button onclick="controlLED('orange', 'off')">æ©˜ç‡ˆ OFF</button>
  </div>

  <!-- è¨Šæ¯å€ -->
  <div class="section-title">ğŸ“¬ MQTT è¨Šæ¯è¨˜éŒ„</div>
  <div id="log"><strong>ğŸ“¬ MQTT è¨Šæ¯å€</strong></div>

  <script>
    // åˆå§‹åŒ– MQTT å®¢æˆ¶ç«¯
    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt', {
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'mqttx_ce657d5d',
      password: ''
    });

    // ä¸»é¡Œ
    const topic_led = 'home/yard/ESP32';
    const topic_dht = 'home/yard/DHT11';

    // é¡¯ç¤ºå€
    const logDiv = document.getElementById('log');
    const statusDiv = document.getElementById('status');
    const sensorDiv = document.getElementById('sensor');

    // è¨˜éŒ„ LED ç‹€æ…‹èˆ‡é¡¯ç¤ºåç¨±
    const ledState = { red: false, green: false, yellow: false, orange: false };
    const ledNames = { red: 'ç´…ç‡ˆ', green: 'ç¶ ç‡ˆ', yellow: 'é»ƒç‡ˆ', orange: 'æ©˜ç‡ˆ' };
    const roomNames = { red: 'å®¢å»³', green: 'å»šæˆ¿', yellow: 'è‡¥å®¤', orange: 'æµ´å®¤' };

    const logs = [];

    // å»ºç«‹é€£ç·šå¾Œè¨‚é–±ä¸»é¡Œ
    client.on('connect', () => {
      addLog("âœ… å·²é€£æ¥åˆ° MQTT Broker");
      client.subscribe(topic_led);
      client.subscribe(topic_dht);
    });

    // æ¥æ”¶è¨Šæ¯
    client.on('message', (topic, payload) => {
      const msg = payload.toString();
      addLog("ğŸ“¥ " + topic + ": " + msg);

      try {
        const json = JSON.parse(msg);
        // è™•ç† LED æ§åˆ¶
        if (topic === topic_led) {
          const { led, action } = json;
          if (led && action) {
            ledState[led] = action === 'on';
            updateStatusDisplay();
          }
        }

        // è™•ç† DHT11 è³‡æ–™
        if (topic === topic_dht) {
          const { temperature, humidity } = json;
          if (temperature !== undefined && humidity !== undefined) {
            sensorDiv.innerText = `ğŸŒ¡ï¸ æº«åº¦ï¼š${temperature.toFixed(1)}Â°Cã€€ğŸ’§ æ¿•åº¦ï¼š${humidity.toFixed(1)}%`;
          }
        }
      } catch (e) {
        console.warn("âŒ ç„¡æ³•è§£æ JSON:", e);
      }
    });

    // ç™¼é€ LED æ§åˆ¶è¨Šæ¯
    function controlLED(color, action) {
      const msg = JSON.stringify({ led: color, action: action });
      client.publish(topic_led, msg, { qos: 1 });
      addLog("ğŸš€ ç™¼é€: " + msg);
    }

    // é¡¯ç¤ºç›®å‰äº®ç‡ˆç‹€æ…‹
    function updateStatusDisplay() {
      const onLeds = Object.entries(ledState)
        .filter(([_, state]) => state)
        .map(([key]) => `${roomNames[key]}ï¼ˆ${ledNames[key]}ï¼‰`);

      if (onLeds.length > 0) {
        statusDiv.innerText = `ğŸ’¡ äº®ç‡ˆï¼š${onLeds.join("ã€")}`;
      } else {
        statusDiv.innerText = `ğŸ”” ç‡ˆç‹€æ…‹ï¼šç›®å‰å…¨éƒ¨ç‚º OFF`;
      }
    }

    // è¨Šæ¯é¡¯ç¤ºæ§åˆ¶ï¼ˆæœ€å¤š 10 ç­†ï¼‰
    function addLog(text) {
      logs.unshift(text);
      if (logs.length > 10) logs.pop();
      logDiv.innerHTML = "<strong>ğŸ“¬ MQTT è¨Šæ¯å€</strong>\n" + logs.join("\n");
    }
  </script>
</body>
</html>
