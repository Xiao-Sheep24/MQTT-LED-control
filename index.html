
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 ç©ºæ°£å“è³ªç›£æ§</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      display: flex;
      padding: 20px;
      background-color: #f0f8ff;
    }
    .main {
      flex: 2;
    }
    .sidebar {
      flex: 1;
      margin-left: 40px;
      padding: 15px;
      border-left: 2px solid #ccc;
    }
    h1 {
      color: #2c3e50;
      font-size: 28px;
    }
    .data-box {
      margin-top: 15px;
      font-size: 20px;
    }
    .quality {
      font-weight: bold;
    }
    .good { color: green; }
    .moderate { color: orange; }
    .bad { color: red; }
    #timestamp {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }
    #status {
      font-size: 18px;
      margin-top: 10px;
    }
    #status.ok { color: green; }
    #status.lost { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="main">
    <h1>ESP32 ç©ºæ°£å“è³ªç›£æ§é é¢</h1>
    <div class="data-box">ğŸŒ¡ï¸ æº«åº¦ï¼š<span id="temp">--</span> Â°C</div>
    <div class="data-box">ğŸ’§ æ¿•åº¦ï¼š<span id="humi">--</span> %RH</div>
    <div class="data-box">ğŸŒ« MQ135 æ•¸å€¼ï¼š<span id="mq135">--</span></div>
    <div class="data-box">ğŸŸ¢ ç©ºæ°£å“è³ªï¼š<span id="quality" class="quality">--</span></div>
    <div id="timestamp">ğŸ“… æœ€æ–°æ™‚é–“ï¼š--</div>
    <div id="status" class="ok">ğŸ“¡ ç‹€æ…‹ï¼šè³‡æ–™æŒçºŒæ›´æ–°ä¸­</div>
  </div>

  <div class="sidebar">
    <h3>ç©ºæ°£å“è³ªå€é–“èªªæ˜</h3>
    <ul>
      <li><span class="good">è‰¯å¥½</span>ï¼š0 ~ 1200</li>
      <li><span class="moderate">æ™®é€š</span>ï¼š1201 ~ 2000</li>
      <li><span class="bad">ä¸ä½³</span>ï¼š2001 ä»¥ä¸Š</li>
    </ul>
  </div>

  <script>
    const options = {
      connectTimeout: 4000,
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      username: 'mqttx_ce657d5d',
      password: '',
    };

    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt', options);
    const topic = 'home/yard/DHT11';
    let lastUpdateTime = Date.now();

    client.on('connect', () => {
      console.log('âœ… å·²é€£æ¥ MQTT');
      client.subscribe(topic, { qos: 1 });
    });

    client.on('message', (topic, payload) => {
      try {
        const data = JSON.parse(payload.toString());
        const temp = data.temperature;
        const humi = data.humidity;
        const mq = data.mq135_raw;
        lastUpdateTime = Date.now();

        document.getElementById("temp").innerText = temp.toFixed(1);
        document.getElementById("humi").innerText = humi.toFixed(1);
        document.getElementById("mq135").innerText = mq;

        const qualityText = document.getElementById("quality");
        if (mq <= 1200) {
          qualityText.innerText = "è‰¯å¥½";
          qualityText.className = "quality good";
        } else if (mq <= 2000) {
          qualityText.innerText = "æ™®é€š";
          qualityText.className = "quality moderate";
        } else {
          qualityText.innerText = "ä¸ä½³";
          qualityText.className = "quality bad";
        }

        document.getElementById("timestamp").innerText = "ğŸ“… æœ€æ–°æ™‚é–“ï¼š" + new Date().toLocaleString();
        document.getElementById("status").innerText = "ğŸ“¡ ç‹€æ…‹ï¼šè³‡æ–™æŒçºŒæ›´æ–°ä¸­";
        document.getElementById("status").className = "ok";
      } catch (e) {
        console.error("âŒ è§£æéŒ¯èª¤", e);
      }
    });

    setInterval(() => {
      if (Date.now() - lastUpdateTime > 10000) {
        document.getElementById("status").innerText = "âš ï¸ ç‹€æ…‹ï¼šè³‡æ–™å·²æ–·ç·š";
        document.getElementById("status").className = "lost";
      }
    }, 3000);
  </script>
</body>
</html>
